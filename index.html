<!doctype html>
<head>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/style.css">
    <meta charset="UTF-8">
    <title>OpenAlcazar</title>
</head>


<script src="js/grid.js"></script>
<script src="js/level.js"></script>
<script src="js/levels.js"></script>
<script src="thirdparty/lzstring/lzstring.js"></script>

<body>

<div id="ui">
    <img src="img/title.png" width="100%"/>
    <h2>An <a href="https://github.com/tchapeaux/alcazar-clone">open-source</a> clone of <a href="http://www.theincrediblecompany.com/try-alcazar">Alcazar</a></h2>
    <p>
        <strong>Rules</strong><br/>
        Enter and exit each square exactly once<br/>
        Enter and exit the room exactly once
    </p>

    <p>
        <strong>Levels</strong><br/>
        <a id="Level_1" href="#">001 (Trivial)</a><br/>
        <a id="Level_2" href="#">002 (Easy)</a><br/>
        <a id="Level_3" href="#">003 (Alcazar Demo Level 5)</a><br/>
    </p>

    <p><a id="LevelEditor" href="#">Toggle Editor mode</a></p>
</div>

<script>
    var link = document.getElementById("Level_1");
    link.onclick = function() { level = getTrivialTestLevel(); redraw(); }
    var link = document.getElementById("Level_2");
    link.onclick = function() { level = getEasyTestLevel(); redraw(); }
    var link = document.getElementById("Level_3");
    link.onclick = function() { level = getMediumTestLevel(); redraw(); }

    function toggleEditorMode() {
        editorMode = !editorMode;
        var form = document.getElementById("editor_form");
        form.style.display = editorMode ? "block" : "none";
        var widthInput = document.getElementById("editor_width");
        widthInput.value = level.grid.sizeX;
        var heightInput = document.getElementById("editor_height");
        heightInput.value = level.grid.sizeY;
        var gameDiv = document.getElementById("game");
        gameDiv.style["background-color"] = editorMode ? "#d4c48e" : "#E9E1C5";
        resetLevel();
    }

    var link = document.getElementById("LevelEditor");
    link.onclick = toggleEditorMode;
</script>

<div id="game">

<span id="winMessage"></span><br/>

<canvas width="800" height="600" onmousemove="mouseMoved(event.pageX - this.offsetLeft + document.documentElement.scrollLeft, event.pageY - this.offsetTop + document.documentElement.scrollTop)" onclick="mouseClick(mouseX, mouseY);"></canvas>


<script>
    var canvas = document.querySelector("canvas");
    canvas.onmousedown = function() {return false;}
    var c = canvas.getContext("2d");

    const W = canvas.width;
    const H = canvas.height;

    var editorMode = false;
    var level = getEasyTestLevel()
    level.fitCanvasDimension(W, H);

    function mouseMoved(newX, newY) {
        mouseX = newX;
        mouseY = newY;
        // highlight closest link
        x = mouseX - W / 2;
        y = mouseY - H / 2;
        var linkDescr = level.getClosestLink(x, y);
        if (linkDescr) {
            var link = level.grid.getLink(linkDescr);
            if (link) {
                link.highlighted = true;
            }
        }
        redraw();
    }

    function mouseClick(x, y) {
        // apply offset to mouse position
        x -= W / 2;
        y -= H / 2;
        var linkDescr = level.getClosestLink(x, y);
        if (!editorMode) {
            if (linkDescr) {
                var link = level.grid.getLink(linkDescr);
                if (link) {
                    switch (link.state) {
                        case TileLink.stateEnum.CLEAR:
                            link.state = TileLink.stateEnum.IN_PATH;
                            break;
                        case TileLink.stateEnum.IN_PATH:
                            link.state = TileLink.stateEnum.USER_WALL;
                            break;
                        case TileLink.stateEnum.USER_WALL:
                            link.state = TileLink.stateEnum.CLEAR;
                            break;
                    }
                    link.highlighted = true;
                }
            }
        }
        else { // editorMode
            var link = null;
            if (linkDescr) { link = level.grid.getLink(linkDescr); }

            if (link && !link.isDoor()) { // level wall toggling
                switch (link.state) {
                    case TileLink.stateEnum.CLEAR:
                        link.state = TileLink.stateEnum.LEVEL_WALL;
                        break;
                    case TileLink.stateEnum.LEVEL_WALL:
                        link.state = TileLink.stateEnum.CLEAR;
                        break;
                }
            } else { // door toggling
                if (!link) {
                    if (linkDescr) {
                        level.makeDoor(linkDescr);
                    } else {
                        var doorDescr = level.getClosestDoorPosition(x, y);
                        // check if door already exists
                        var doorLink = level.grid.getLink(doorDescr);
                        if (doorLink) {
                            level.removeDoor(doorDescr);
                        } else {
                            level.makeDoor(doorDescr);
                        }
                    }
                } else {
                    // assert link is door (should be enforced earlier)
                    if (!link.isDoor()) { throw new Error("Invalid door position"); }
                    level.removeDoor(linkDescr);
                }
            }
        }

        redraw();

        if (level.isFinished()) {
            winMessage.textContent = "You win !";
        } else {
            winMessage.textContent = "";
        }
    }

    function resetLevel() {
        level.reset();
        redraw();
    }

    var background_img = new Image;
    background_img.onload = redraw;
    background_img.src = "img/background_pattern.png";

    function redraw() {
        c.save();
        var pat = c.createPattern(background_img, "repeat");
        c.save();
        c.fillStyle = pat;
        c.setLineDash([]);
        c.beginPath();
        c.rect(0, 0, W, H);
        c.fill();
        c.restore();
        if (editorMode) {
            c.save()
            c.fillStyle = "rgb(100, 100, 100)";
            c.globalAlpha = 0.5;
            c.beginPath();
            c.rect(0, 0, W, H);
            c.fill();
            c.restore()
        }

        c.translate(W / 2, H / 2);
        level.draw(c);

        c.restore();
    }

    window.onload = redraw;

</script>

<br/>
<button onclick="resetLevel()">Reset Level</button>

<div id="editor_form">
<h2>EDITOR MODE ENABLED</h2>

<form>
    Width: <input type="number" name="gridWidth" id="editor_width" min="1" max="20" size="2"> |
    Height: <input type="number" name="gridWidth" id="editor_height" min="1" max="20" size="2">
</form>

<script>

    var widthInput = document.getElementById("editor_width");
    widthInput.onchange = function() {
        var newWidth = parseInt(widthInput.value);
        level.resize(newWidth, level.grid.sizeY);
        level.fitCanvasDimension(W, H);
        redraw();
    }
    var heightInput = document.getElementById("editor_height");
    heightInput.onchange = function() {
        var newHeight = parseInt(heightInput.value);
        level.resize(level.grid.sizeX, newHeight);
        level.fitCanvasDimension(W, H);
        redraw();
    }

</script>

<p>Click in the level to modify walls and doors.</p>

</div>

</div>

</body>
